<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sam AI</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="chat-wrapper">

    <!-- HEADER -->
    <div class="chat-header">
        <h1>ü§ñ Sam AI</h1>
        <p>Your Personal Study Assistant</p>
        <span class="creator">Created by Samir Singh</span>
        <a href="/clear" class="clear-btn">üóëÔ∏è Clear Chat</a>
    </div>

    <!-- CHAT BODY -->
    <div class="chat-body" id="chatBody"></div>

    <!-- INPUT -->
    <form id="chatForm" class="chat-input">
        <textarea id="questionBox"
                  placeholder="Type your message..."
                  required></textarea>
        <button type="submit">‚û§</button>
    </form>

</div>

<script>
const chatBody = document.getElementById("chatBody");
const form = document.getElementById("chatForm");
const textarea = document.getElementById("questionBox");

function scrollBottom() {
    chatBody.scrollTop = chatBody.scrollHeight;
}

// ENTER to send
textarea.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event("submit"));
    }
});

form.addEventListener("submit", async e => {
    e.preventDefault();

    const question = textarea.value.trim();
    if (!question) return;

    // USER MESSAGE
    chatBody.innerHTML += `
        <div class="msg-row right">
            <div class="user-msg">${question}</div>
        </div>
    `;
    scrollBottom();
    textarea.value = "";

    // THINKING MESSAGE
    const thinkingDiv = document.createElement("div");
    thinkingDiv.className = "msg-row left";
    thinkingDiv.innerHTML = `
        <div class="ai-msg thinking">Sam AI is thinking...</div>
    `;
    chatBody.appendChild(thinkingDiv);
    scrollBottom();

    // SEND TO BACKEND
    const res = await fetch("/ask", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({question})
    });

    const data = await res.json();

    // REMOVE THINKING
    thinkingDiv.remove();

    // IMAGE RESPONSE
    if (data.type === "image") {
        chatBody.innerHTML += `
            <div class="msg-row left">
                <div class="ai-msg">
                    <img src="${data.content}"
                         style="max-width:100%; border-radius:10px;">
                    <br><br>
                    <a href="${data.content}" target="_blank">‚¨áÔ∏è Download Image</a>
                </div>
            </div>
        `;
        scrollBottom();
        return;
    }

    // TEXT RESPONSE (LINE BY LINE)
    const lines = data.content.split("\n");
    const aiBox = document.createElement("div");
    aiBox.className = "msg-row left";
    aiBox.innerHTML = `<div class="ai-msg"></div>`;
    chatBody.appendChild(aiBox);
    scrollBottom();

    const aiMsg = aiBox.querySelector(".ai-msg");
    let i = 0;

    const interval = setInterval(() => {
        if (i < lines.length) {
            aiMsg.innerHTML += lines[i] + "<br>";
            scrollBottom();
            i++;
        } else {
            clearInterval(interval);
        }
    }, 450); // üëà line delay
});
</script>

</body>
</html>
